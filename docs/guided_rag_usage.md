# Guided RAG 使用說明

本模組整合於 `consult_chat_app.py`，透過向量庫 + GPT-4o 實現引導式自由問答，協助使用者在不清楚如何回答問卷時提供漸進式提示。

---

## 🎯 功能定位

| 功能            | 說明 |
|------------------|------|
| 啟動條件         | 問卷中任一題皆可進入引導問答區 |
| 啟動方式         | 使用者輸入問題或「不知道」 |
| 查詢方式         | 使用內建 FAISS 向量庫進行語意搜尋 |
| 回答模型         | OpenAI GPT-4o（可改為 3.5） |
| 最多互動次數     | 3 輪引導對話 |
| 結束條件         | 使用者輸入答案或選擇「跳過此題」 |


## 🧩 模組結構

### 1. `src/managers/guided_rag.py`

| 方法             | 說明 |
|------------------|------|
| `__init__()`      | 載入向量庫與模型設定 |
| `search_related_chunks()` | 查詢與輸入問題最相關的段落 |
| `build_prompt()` | 建構 RAG 回答提示語（含 context）|
| `ask()`           | 執行查詢與回應邏輯，回傳 GPT 回答與引用內容 |


### 2. 修改 `consult_chat_app.py`

- 建立 `guided_rag` 實例並檢查向量庫存在
- 使用 `st.session_state['guided_turns']` 控制回合數
- 使用 `st.session_state['guided_chat']` 紀錄上下文對話
- 每題最多 3 輪互動後提供「跳過」按鈕
- 若點選跳過，自動標記作答為「未回答」並進入下一題


## 🧠 Prompt 設計（範例）

```text
你是一位專業的永續顧問，正在引導客戶完成 ESG 問卷。
根據以下背景資料，請幫助使用者理解問題，並試著引導對方選出適當的選項。
若使用者說「不知道」或無法回答，請進一步說明或提供範例幫助其理解。
```


## 📝 其他設計說明

- 每輪 GPT 回應後提供 2–3 個方向性建議，協助使用者思考
- 顧問回應與使用者問題均記錄於 `guided_chat` session 中
- 顯示 chunk 來源檔名與頁碼，協助引用與驗證
- 使用者回覆任意文字皆視為作答完成（非一定要選項）
- 設計考量以教育與診斷為導向，非考試

---

此模組可與報告生成整合，作為額外的參考資料來源。
未來也可延伸做「使用者困難統計」、「未回答題標記」、「常見問題收斂」等應用。

