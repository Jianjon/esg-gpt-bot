# src/utils/prompt_builder.py

import json
from src.utils.gpt_tools import call_gpt
from src.managers.profile_manager import get_user_profile
from src.utils.rag_retriever import get_rag_context_for_question

TONE_STYLE_MAP = {
    "gentle": "èªæ°£è«‹æº«å’Œã€é¼“å‹µï¼Œå°±åƒæ˜¯ä¸€ä½è¦ªåˆ‡çš„é¡§å•é™ªä¼´ä¼æ¥­ä¸»å­¸ç¿’ã€‚",
    "professional": "èªæ°£è«‹å°ˆæ¥­ã€é‚è¼¯æ¸…æ™°ï¼Œåƒåœ¨å’Œä¸»ç®¡ç´šä½¿ç”¨è€…ç°¡å ±é‡é»ã€‚",
    "creative": "èªæ°£è«‹å•Ÿç™¼æ€§ã€è·³è„«å‚³çµ±ï¼Œé¼“å‹µä½¿ç”¨è€…å¾ä¸åŒè¦–è§’æ€è€ƒã€‚"
}

def build_learning_prompt(
    user_profile: dict,
    current_q: dict,
    previous_summary: str,
    tone: str = "gentle"
) -> str:
    """
    ç¬¬äºŒé¡Œä»¥å¾Œå°ˆç”¨ï¼šæ ¹æ“šã€Œä¸Šä¸€é¡Œæ‘˜è¦ + ä½¿ç”¨è€…è§’è‰² + æœ¬é¡Œå…§å®¹ã€ï¼Œç”¢å‡ºå°è«–å°çµèªªæ˜ã€‚
    """
    from src.utils.gpt_tools import call_gpt
    import json

    style_instruction = TONE_STYLE_MAP.get(tone, TONE_STYLE_MAP["gentle"])
    industry = user_profile.get("industry", "æŸç”¢æ¥­")
    role = user_profile.get("role", "ä¼æ¥­å…§éƒ¨äººå“¡")
    profile_json = json.dumps(user_profile, ensure_ascii=False, indent=2)

    prompt = f"""
ä½ æ˜¯ä¸€ä½ ESG é¡§å•ï¼Œæ­£åœ¨é€é¡Œå¼•å°ä¼æ¥­ç”¨æˆ¶{style_instruction}å®Œæˆ ESG å•å·å­¸ç¿’ã€‚

æœ¬é¡Œç‚ºç¬¬äºŒé¡Œä¹‹å¾Œï¼Œè«‹æ ¹æ“šã€Œä¸Šä¸€é¡Œæ‘˜è¦ã€ï¼Œæä¾›ä¸€æ®µå°è«–èªªæ˜ï¼Œå¹«åŠ©ä½¿ç”¨è€…å›é¡§å‰é¡Œé‡é»ä¸¦è‡ªç„¶é€²å…¥æ–°å•é¡Œçš„æ€è€ƒ,åŠå»ºè­°çš„ç®¡ç†ä½œæ³•ã€‚

ğŸ§‘â€ğŸ’¼ã€ä½¿ç”¨è€…è§’è‰²ã€‘ï¼š{role}
ğŸ­ã€ç”¢æ¥­é¡åˆ¥ã€‘ï¼š{industry}
ğŸ“˜ã€ä½¿ç”¨è€…èƒŒæ™¯ã€‘ï¼š
{profile_json}

ğŸ“Œã€ä¸Šä¸€é¡Œæ‘˜è¦ã€‘ï¼š
{previous_summary or 'ï¼ˆå°šç„¡æ‘˜è¦ï¼‰'}


âœ…ã€æ’°å¯«æŒ‡å¼•ã€‘ï¼š
- ä»¥ä¸€æ®µè‡ªç„¶èªå¥ï¼Œå…ˆå›é¡§ä¸Šé¡Œé‡é»ï¼Œå†éŠœæ¥èªªæ˜æœ¬é¡Œé‡é»
- å¯ä½¿ç”¨æ¢åˆ—ã€åˆ†æ®µæˆ–èªå¥èªªæ˜ï¼Œä¿æŒè¦ªåˆ‡ã€å…·é‚è¼¯æ„Ÿ
- é©ç•¶ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿï¼ˆğŸ“Œã€âœ…ã€ğŸ“ï¼‰è¼”åŠ©å¼·èª¿


âš ï¸ ä¸éœ€è¦åŠ å…¥ä»»ä½•æ¨™é¡Œæˆ–æç¤ºï¼Œè«‹ç›´æ¥é–‹å§‹è¼¸å‡ºé¡§å•å¼èªªæ˜ã€‚
"""
    return call_gpt(prompt).strip()


def build_intro_welcome_prompt(user_profile: dict, current_q: dict, tone: str = "gentle") -> str:
    style_instruction = TONE_STYLE_MAP.get(tone, TONE_STYLE_MAP["gentle"])
    industry = user_profile.get("industry", "æŸç”¢æ¥­")
    role = user_profile.get("role", "ä¸€èˆ¬æˆå“¡")
    motivation = user_profile.get("q2", "")
    profile_json = json.dumps(user_profile, ensure_ascii=False, indent=2)

    prompt = f"""
ä½ æ˜¯ä¸€ä½ ESG é¡§å•ï¼Œç¾åœ¨æ­£å”åŠ©ä¼æ¥­ä½¿ç”¨è€…é€²å…¥ ESG å­¸ç¿’å•å·çš„ç¬¬ä¸€é¡Œã€‚

è«‹é‡å°ä»¥ä¸‹è³‡è¨Š{style_instruction}ï¼Œç”¢å‡ºä¸€æ®µè¦ªåˆ‡ã€å…·é¼“å‹µæ€§çš„é–‹å ´èªªæ˜ï¼Œè®“ä½¿ç”¨è€…ç†è§£é€™ä»½å•å·çš„ç›®çš„èˆ‡åƒèˆ‡åƒ¹å€¼ï¼š

ğŸ§‘â€ğŸ’¼ã€ä½¿ç”¨è€…è§’è‰²ã€‘ï¼š{role}
ğŸ­ã€ç”¢æ¥­é¡åˆ¥ã€‘ï¼š{industry}
ğŸ¯ã€å­¸ç¿’å‹•æ©Ÿã€‘ï¼š{motivation}
ğŸ“˜ã€èƒŒæ™¯æ‘˜è¦ã€‘ï¼š
{profile_json}

ğŸ“ã€å¼•å°ç›®æ¨™ã€‘ï¼š
- ç‚ºä½•é€™ä»½å•å·å°ä¼æ¥­ä¸»/å“¡å·¥/ç®¡ç†å±¤æœ‰å¹«åŠ©ï¼Ÿ
- å¦‚ä½•å”åŠ©ä»–ç†è§£ ESG / ç¢³ç›¤æŸ¥æ¦‚å¿µï¼Ÿ
- é å‘Šå•å·æœƒæ€éº¼é€²è¡Œï¼Œè®“äººæœ‰å®‰å…¨æ„Ÿ

ğŸ§ ã€æ ¼å¼å»ºè­°ã€‘è«‹æ ¹æ“šå…§å®¹éˆæ´»é¸æ“‡é©åˆçš„å‘ˆç¾æ–¹å¼ï¼š
- è‹¥ç‚ºæ¯”è¼ƒå‹ã€æ¢ä»¶å‹ã€å°æ‡‰é‚è¼¯ â†’ å¯ä½¿ç”¨è¡¨æ ¼å‘ˆç¾
- è‹¥ç‚ºæ¸…å–®ã€æ“ä½œæ­¥é©Ÿã€æ³¨æ„äº‹é … â†’ è«‹ä½¿ç”¨æ¢åˆ—æ¸…å–®
- å›æ‡‰æ–‡å­—è«‹æ§åˆ¶åœ¨ ChatGPT é¢¨æ ¼çš„å…§æ–‡ç¯„åœ,ç´„ 16px é¡¯ç¤ºå¤§å°, æ¨™é¡Œå­—ç‚º 18px

âœ… è«‹ç”¢å‡ºç´„ 150 å­—è‡ªç„¶èªªæ˜èªå¥ã€‚
- å›æ‡‰åªç”¢å‡ºæ–‡å­—å…§å®¹ï¼Œä¸è¦åŠ ä¸Šæ¨™é¡Œæˆ–å…¶ä»–èªªæ˜ã€‚
- ä¸å¯ä½¿ç”¨ã€Œä½ ã€ã€Œå¦³ã€æˆ–ã€Œä¼æ¥­ä¸»ã€ç­‰ç¨±è¬‚ï¼Œä¿æŒä¸­æ€§å¯¦å‹™é¢¨æ ¼ã€‚
"""
    return call_gpt(prompt).strip()

def build_learning_prompt(user_profile: dict, current_q: dict, previous_summary: str, tone: str = "gentle") -> str:
    style_instruction = TONE_STYLE_MAP.get(tone, TONE_STYLE_MAP["gentle"])
    industry = user_profile.get("industry", "æŸç”¢æ¥­")
    role = user_profile.get("role", "ä¼æ¥­å…§éƒ¨äººå“¡")
    profile_json = json.dumps(user_profile, ensure_ascii=False, indent=2)

    prompt = f"""
ä½ æ˜¯ä¸€ä½ ESG é¡§å•ï¼Œæ­£åœ¨é€é¡Œå¼•å°ä¼æ¥­ç”¨æˆ¶{style_instruction}å®Œæˆ ESG å•å·å­¸ç¿’ã€‚

æœ¬é¡Œç‚ºç¬¬äºŒé¡Œä»¥å¾Œï¼Œè«‹æ ¹æ“šã€Œä¸Šä¸€é¡Œæ‘˜è¦ã€ï¼Œæä¾›ä¸€æ®µå°è«–èªªæ˜ï¼Œå¹«åŠ©ä½¿ç”¨è€…å›é¡§å‰é¡Œé‡é»ä¸¦è‡ªç„¶é€²å…¥æ–°å•é¡Œçš„æ€è€ƒåŠå»ºè­°çš„ç®¡ç†ä½œæ³•ã€‚

ğŸ§‘â€ğŸ’¼ã€ä½¿ç”¨è€…è§’è‰²ã€‘ï¼š{role}
ğŸ­ã€ç”¢æ¥­é¡åˆ¥ã€‘ï¼š{industry}
ğŸ“˜ã€ä½¿ç”¨è€…èƒŒæ™¯ã€‘ï¼š
{profile_json}
ğŸ“Œã€ä¸Šä¸€é¡Œæ‘˜è¦ã€‘ï¼š
{previous_summary or 'ï¼ˆå°šç„¡æ‘˜è¦ï¼‰'}

âœ…ã€æ’°å¯«æŒ‡å¼•ã€‘ï¼š
- ä»¥ä¸€æ®µè‡ªç„¶èªå¥ï¼Œå…ˆå›é¡§ä¸Šé¡Œé‡é»ï¼Œå†éŠœæ¥èªªæ˜æœ¬é¡Œé‡é»
- å¯ä½¿ç”¨æ¢åˆ—ã€åˆ†æ®µæˆ–èªå¥èªªæ˜ï¼Œä¿æŒè¦ªåˆ‡ã€å…·é‚è¼¯æ„Ÿ
- é©ç•¶ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿï¼ˆğŸ“Œã€âœ…ã€ğŸ“ï¼‰è¼”åŠ©å¼·èª¿
- è«‹æ§åˆ¶åœ¨ 120â€“180 å­—ä¹‹é–“ï¼Œä¸éœ€æ¨™é¡Œæˆ–é¡å¤–æ¡†ç·š
"""
    return call_gpt(prompt).strip()

def generate_user_friendly_prompt(current_q: dict, user_profile: dict, rag_context: str = "", tone: str = "gentle") -> str:
    learning_goal = current_q.get("learning_goal", "")
    topic = current_q.get("topic", "")
    user_profile_json = json.dumps(user_profile, ensure_ascii=False, indent=2)
    industry = user_profile.get("industry", "æŸç”¢æ¥­")
    role = user_profile.get("role", "ä¼æ¥­å…§éƒ¨äººå“¡")

    if not rag_context:
        try:
            rag_context = get_rag_context_for_question(current_q)
        except Exception as e:
            print(f"âš ï¸ ç„¡æ³•å–å¾—è£œå……è³‡æ–™ï¼š{e}")
            rag_context = ""

    style_instruction = TONE_STYLE_MAP.get(tone, TONE_STYLE_MAP["gentle"])

    prompt = f"""
ä½ æ˜¯ä¸€ä½è³‡æ·± ESG é¡§å•ï¼Œæ­£åœ¨æ’°å¯«æ•™å­¸å°è®€ã€‚ä»¥ä¸‹æ˜¯æœ¬é¡Œå…§å®¹ã€ä½¿ç”¨è€…èƒŒæ™¯èˆ‡è£œå……è³‡æ–™ï¼Œè«‹ç”¢å‡ºä¸€æ®µã€Œæ•™ç§‘æ›¸å¼å°è®€èªã€ï¼Œæ ¼å¼çµ±ä¸€ã€èªæ°£å°ˆæ¥­è‡ªç„¶ï¼Œä¸¦ä¾è§’è‰²å®¢è£½åŒ–é‡é»èªªæ˜ã€‚

ã€ä»»å‹™æ ¼å¼ã€‘
è«‹ç”¨ä¸‹åˆ—çµæ§‹æ’°å¯«å›æ‡‰ï¼šæ¨™é¡Œå­—ä¸è¦å¤ªå¤§ï¼Œå»ºè­° 16px

ã€ä¸»é¡Œæ¦‚è¿°ã€‘
ä¸€æ®µ 80-100 å­—ç°¡è¦èªªæ˜è©²é¡Œç›®çš„æ ¸å¿ƒæ¦‚å¿µæˆ–èƒŒæ™¯ã€‚èªªæ˜è©²é¡Œç›®å°æ–¼ä½¿ç”¨è€…è§’è‰²çš„æ„ç¾©æˆ–å½±éŸ¿ã€‚
æ ¹æ“šä½¿ç”¨è€…è§’è‰²ï¼Œèªªæ˜å…¶æ‡‰ç‰¹åˆ¥æ³¨æ„çš„é¢å‘ï¼Œæ§åˆ¶åœ¨ 2â€“3 å¥å…§ã€‚

ã€æ€è€ƒå»ºè­°ã€‘  
ä»¥æ¢åˆ—å¼åˆ—å‡º 3â€“5 é»è©•ä¼°ã€è³‡æ–™æº–å‚™ã€æˆ–åˆ¤æ–·æ–¹å‘ï¼Œä¾¿æ–¼ä½¿ç”¨è€…ä½œç­”ã€‚

ã€ç›®æ¨™ã€‘
- å»ºè­°å¿…é ˆèƒ½çœŸæ­£åŸ·è¡Œï¼Œä¸å¾—ç©ºæ³›
- èšç„¦å¯¦éš›è¡Œå‹•ï¼šå¯ä»¥å»ºç«‹ä»€éº¼åˆ¶åº¦ã€æ‰¾èª°åˆä½œã€åšå“ªç¨®æº–å‚™
- æ¯æ¢å»ºè­°ç¨ç«‹æˆå¥ï¼Œç°¡æ½”æœ‰åŠ›ï¼Œä¸è£œå……èªªæ˜ã€ä¸åŒ…è£èªæ°£

ã€èªæ°£é¢¨æ ¼ã€‘
- è«‹æ¨¡ä»¿ GPT èˆ‡ä½¿ç”¨è€…çš„å°è©±èªæ°£
- **èªæ°£æº«å’Œä½†å‹™å¯¦**ï¼Œå¯ä»¥åŠ å…¥ã€Œé€™æ¨£èƒ½å¹«åŠ©â‹¯ã€ã€Œé€™æ¨£åšå¯ä»¥ç¢ºä¿â‹¯ã€ç­‰è§£é‡‹,ä¸ç”¨é¼“å‹µæ€§èªæ°£
- å¯æ­é… **ç²—é«”é—œéµè©** æˆ– emoji åšè¦–è¦ºå¼·èª¿

ã€æ’ç‰ˆè¦æ±‚ã€‘
- è«‹å°‡å»ºè­°åˆ†ç‚º 3~5 æ®µï¼Œæ¯ä¸€æ®µä»¥ emojiï¼ˆâœ… ğŸ“Œ ğŸ”§ ç­‰ï¼‰é–‹é ­
- æ¯æ®µè½**ä¸è¶…éå…©è¡Œ**ï¼Œä¸­é–“å¯é©åº¦æ›è¡Œï¼Œä¿æŒ GPT å°è©±é¢¨æ ¼çš„ç¯€å¥
- æ¯æ®µéƒ½æ‡‰åŒ…å«ä¸€å€‹ã€Œæ˜ç¢ºè¡Œå‹•ã€+ã€Œé€™æ¨£åšçš„åŸå› ã€
- ä¿æŒç•™ç™½èˆ‡å¯è®€æ€§ï¼Œé¿å…å¯†å¯†éº»éº»,æ’ç‰ˆè¦å¥½çœ‹,ä¸èƒ½å¤ªå¯†é›†
- æ¢åˆ—å¼æ™‚è©¦å¾—è¦æ–·è¡Œï¼Œä¸èƒ½å¤ªé•·

ã€æ ¼å¼æç¤ºã€‘
- **ç²—é«”** ç”¨æ–¼å¼·èª¿é‡é»
- ã€Œã€ç”¨æ–¼æŠ€è¡“è¡“èªã€å°ˆæœ‰è©
- ï¼ˆï¼‰ç”¨æ–¼è¼”åŠ©èªªæ˜æˆ–åˆ¤æ–·æ¢ä»¶
- è‹¥éœ€æ¢åˆ—å¼èªªæ˜ï¼Œè«‹ä½¿ç”¨ã€Œ-ã€é–‹é ­çš„æ¸…å–®æ ¼å¼
- è‹¥éœ€å¼•ç”¨æˆ–åƒè€ƒè³‡æ–™ï¼Œè«‹ä½¿ç”¨ã€Œ>ã€é–‹é ­çš„å¼•ç”¨æ ¼å¼
- å›æ‡‰æ–‡å­—è«‹æ§åˆ¶åœ¨ ChatGPT é¢¨æ ¼çš„å…§æ–‡ç¯„åœï¼ˆç´„ 16px é¡¯ç¤ºå¤§å°ï¼‰
- ä¸è¦ä½¿ç”¨ã€Œä½ ã€ã€Œå¦³ã€æˆ–ã€Œä¼æ¥­ä¸»ã€ç­‰ç¨±è¬‚ï¼Œä¿æŒä¸­æ€§å¯¦å‹™é¢¨æ ¼
- ä¸è¦ä½¿ç”¨ã€Œè«‹ã€æˆ–ã€Œå»ºè­°ã€ç­‰èªæ°£ï¼Œä¿æŒä¸­æ€§å¯¦å‹™é¢¨æ ¼  

ã€å­¸ç¿’ç›®æ¨™ã€‘<-"è¶…ç´šé‡è¦"-è¦èšç„¦åœ¨é€™å€‹å­¸ç¿’ç›®æ¨™,ä¸éœ€è¦é‡è¤‡é¡Œç›®å…§å®¹,ä¸è¦ç™¼æ•£æˆ–æ˜¯åé¡Œ,æˆ–è¬›å¾—å¤ªå»£æ³›
{learning_goal or 'ï¼ˆæœ¬é¡Œå°šæœªæä¾›å­¸ç¿’ç›®æ¨™ï¼‰'}

ã€ä½¿ç”¨è€…è§’è‰²ã€‘
{role}

ã€è¡Œæ¥­ã€‘
{industry}

ã€ä½¿ç”¨è€…å®Œæ•´è³‡æ–™ã€‘
{user_profile_json}

ã€è£œå……è³‡æ–™ã€‘
{rag_context or 'ï¼ˆç„¡ï¼‰'}

ã€èªæ°£é¢¨æ ¼ã€‘
{style_instruction}

è«‹ä¾ä»¥ä¸Šæ ¼å¼æ’°å¯«å…§å®¹ã€‚
"""
    return call_gpt(prompt).strip()

def generate_dynamic_question_block(user_profile: dict, current_q: dict, user_answer: str = "", tone: str = "gentle") -> str:
    question_text = current_q.get("text", "")
    question_note = current_q.get("question_note", "")
    learning_goal = current_q.get("learning_goal", "")
    role = user_profile.get("role", "ä¼æ¥­å…§éƒ¨äººå“¡")
    industry = user_profile.get("industry", "æŸç”¢æ¥­")
    profile_json = json.dumps(user_profile, ensure_ascii=False)
    tone_instruction = TONE_STYLE_MAP.get(tone, TONE_STYLE_MAP["gentle"])

    prompt = f"""
ä½ æ˜¯ä¸€ä½ ESG é¡§å•ï¼Œæ“…é•·æ’°å¯«é‡å°ä¸­å°ä¼æ¥­çš„å•é¡Œå°å¼•èªªæ˜ã€‚ä»¥ä¸‹æ˜¯æŸä¸€é¡Œçš„é¡Œç›®èƒŒæ™¯èˆ‡ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹æ’°å¯«ä¸€æ®µ 80ï½120 å­—çš„ã€Œå•é¡Œå¼•å°èªã€ï¼Œå¼·èª¿é¸é …çš„å·®ç•°æ€§ã€å¸¸è¦‹çš„èª¤è§£æˆ–é¢¨éšªï¼Œå¹«åŠ©ä½¿ç”¨è€…ç†è§£è‡ªå·±è©²æ€éº¼åˆ¤æ–·é¸é …ã€‚

ã€è§’è‰²ã€‘ï¼š{role}
ã€ç”¢æ¥­ã€‘ï¼š{industry}
ã€ä½¿ç”¨è€…å®Œæ•´èƒŒæ™¯ã€‘ï¼š
{profile_json}

ã€é¡Œç›®ã€‘ï¼š
{question_text}

ã€è£œå……èªªæ˜ã€‘ï¼š
{question_note}

ã€å­¸ç¿’ç›®æ¨™ã€‘ï¼š
{learning_goal}

ã€èªæ°£é¢¨æ ¼ã€‘ï¼š{tone_instruction}

ã€å¯«ä½œæ ¼å¼è¦æ±‚ã€‘
- âŒ ä¸æ‰“æ‹›å‘¼ã€ä¸å®¢å¥—ã€ä¸ç¨±å‘¼ä½¿ç”¨è€…
- âŒ ä¸éœ€è¦æ¨™é¡Œæˆ–æç¤ºèªï¼Œç›´æ¥é–‹å§‹æ’°å¯«
- âœ… ä»¥è‡ªç„¶èªå¥å¼•å°ä½¿ç”¨è€…æ€è€ƒï¼Œå¼·èª¿é¸é …å·®ç•°æˆ–èª¤è§£
- âœ… å¯ä½¿ç”¨æ¢åˆ—å¼æˆ–"åˆ†æ®µèªªæ˜"ï¼Œä¿æŒè¦ªåˆ‡ã€å…·é‚è¼¯æ„Ÿ
- âœ… æ¯æ®µä¸è¶…é 3 è¡Œï¼Œç¸½å­—æ•¸æ§åˆ¶åœ¨ 80â€“120 å­—ä¹‹é–“,æ’ç‰ˆè¦å¥½çœ‹,ä¸èƒ½å¤ªå¯†é›†
- æ¢åˆ—å¼æ™‚è©¦å¾—è¦æ–·è¡Œï¼Œä¸èƒ½å¤ªé•·

ã€ç›®æ¨™ã€‘
- å¼•å°ä½¿ç”¨è€…ç†è§£ã€Œè©²å¦‚ä½•åˆ¤æ–·é¸é …ã€
- ä¸éœ€è§£é‡‹æ¯å€‹é¸é …ï¼ˆé¸é …è£œå……æœƒå¦å¤–é¡¯ç¤ºï¼‰
- é¿å…å¯†å¯†éº»éº»ï¼Œè«‹ç”¨ 2ï½3 æ®µè½ï¼Œæ¯æ®µä¸è¶…é 3 è¡Œ

ã€èªæ°£é¢¨æ ¼ã€‘
- å£å»è¦ªåˆ‡è‡ªç„¶ï¼Œä½†ä¸èª‡å¼µã€ä¸è‡ªå•è‡ªç­”
- åƒ GPT å‘ç”¨æˆ¶ç°¡å–®èªªæ˜å•é¡Œç„¦é»çš„æ–¹å¼

ã€æ’ç‰ˆæ ¼å¼ã€‘
- é¦–æ®µç‚ºã€Œé¡Œç›®çš„æ„ç¾©ã€æˆ–ã€Œå¸¸è¦‹æ€è€ƒç›²é»ã€
- ç¬¬äºŒæ®µç”¨ âœ… æˆ– ğŸ“Œ å¼•å°æ¢åˆ—ï¼Œå¯åˆ—å‡º 1ï½2 é»åˆ¤æ–·æ–¹å‘
- æœ€å¾Œä¸€è¡Œç¸½çµï¼šæé†’ä½¿ç”¨è€…ä¾æ“šè‡ªèº«æƒ…å¢ƒæ€è€ƒ
- ä¸è¦ä½¿ç”¨ã€Œä½ ã€ã€Œå¦³ã€æˆ–ã€Œä¼æ¥­ä¸»ã€ç­‰ç¨±è¬‚ï¼Œä¿æŒä¸­æ€§å¯¦å‹™é¢¨æ ¼
- ä¸è¦ä½¿ç”¨ã€Œè«‹ã€æˆ–ã€Œå»ºè­°ã€ç­‰èªæ°£ï¼Œä¿æŒä¸­æ€§å¯¦å‹™é¢¨æ ¼

ğŸ“¤ è«‹æ ¹æ“šä¸Šæ–¹å…§å®¹ç›´æ¥æ’°å¯«ä¸€æ®µã€Œé‡å°è©²é¡Œçš„é¡§å•å¼æå•å¼•å°èªã€ã€‚
"""
    return call_gpt(prompt).strip()

def generate_option_notes(current_q: dict, user_profile: dict = {}, tone: str = "gentle") -> dict:
    options = current_q.get('options', [])
    question_text = current_q.get('text', '')
    option_text = "\n".join([f"- {opt}" for opt in options])
    profile_hint = json.dumps(user_profile, ensure_ascii=False, indent=2)

    prompt = f"""
ä½ æ˜¯ä¸€ä½ ESG é¡§å•ï¼Œæ“…é•·é‡å°é¡Œç›®é¸é …é€²è¡Œç°¡æ½”èªªæ˜ã€‚ä»¥ä¸‹æ˜¯é¡Œç›®å…§å®¹èˆ‡ä½¿ç”¨è€…èƒŒæ™¯ï¼š

ã€é¡Œç›®å…§å®¹ã€‘
{question_text}

ã€é¸é …ã€‘
{option_text}

ã€ä½¿ç”¨è€…èƒŒæ™¯ã€‘
{profile_hint}

ğŸ“Œ è«‹æ ¹æ“šä½¿ç”¨è€…çš„ã€Œç”¢æ¥­ã€ã€ã€Œè§’è‰²ã€èˆ‡ã€Œä½œç­”å‹•æ©Ÿã€ï¼Œé‡å°æ¯å€‹é¸é …è£œå……ä¸€å¥ 15~25 å­—çš„ä¸­æ–‡èªªæ˜ã€‚
è«‹ç›¡é‡è²¼è¿‘è©²ç”¢æ¥­çš„å¯¦éš›æƒ…å¢ƒèˆ‰ä¾‹ï¼Œä¾‹å¦‚å…§å ´ç®¡ç†ã€ä¾›æ‡‰å•†åˆä½œã€äººåŠ›é…ç½®ç­‰ã€‚
èªæ°£è«‹ç¬¦åˆã€Œ{tone}ã€é¢¨æ ¼ï¼Œé¿å…ä½¿ç”¨è¡“èªæˆ–æ¨¡ç³Šå­—è©ã€‚

è«‹å›å‚³ JSON æ ¼å¼å¦‚ä¸‹ï¼š
{{
  "é¸é …1": "è£œå……èªªæ˜",
  "é¸é …2": "è£œå……èªªæ˜"
}}

âœ… è«‹ç›´æ¥è¼¸å‡º JSON çµæœï¼Œä¸éœ€è¦å…¶ä»–èªªæ˜æ–‡å­—ã€‚
"""

    response = call_gpt(prompt)

    try:
        response = response.strip()
        if response.startswith("```json"):
            response = response.lstrip("```json").rstrip("```").strip()
        elif response.startswith("```"):
            response = response.lstrip("```").rstrip("```").strip()

        return json.loads(response)
    except Exception as e:
        print(f"âš ï¸ GPT å›å‚³è§£æå¤±æ•—ï¼š{e}\nåŸå§‹å›æ‡‰ï¼š{response}")
        return {opt: "" for opt in options}